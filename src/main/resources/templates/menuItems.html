<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>菜单概览-您的界面</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f9f9f9;
    }
    .container {
      width: 80%;
      margin: 0 auto;
      padding: 20px;
      background-color: #fff;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      border-radius: 8px;
    }
    h1 {
      text-align: center;
      color: #333;
    }
    h2 {
      text-align: center;
      color: #333;
    }
    h3 {
      text-align: center;
      color: #333;
    }
    button {
      text-align: center;
      color: #333;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 20px 0;
    }
    table, th, td {
      border: 1px solid #ccc;
    }
    th, td {
      padding: 10px;
      text-align: left;
    }
    th {
      background-color: #f2f2f2;
    }
    tr:nth-child(even) {
      background-color: #f9f9f9;
    }
    tr:hover {
      background-color: #f1f1f1;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>菜单概览-您的界面</h1>
  <table>
    <thead>
    <tr>
      <th>菜单项目ID</th>
      <th>菜品名称</th>
      <th>价格</th>
      <th>已选数量</th>
      <th>操作</th>
    </tr>
    </thead>
    <tbody>
    <tr th:each="menuItem : ${menuItems}">
      <td th:text="${menuItem.menuItemId}">菜单项目ID</td>
      <td th:text="${menuItem.dishName}">菜品名称</td>
      <td th:text="${menuItem.price}">价格</td>
      <!--<td id="quantity-${menuItem.menuItemId}">0</td>-->
      <td id="quantity">0</td>
      <td>
        <button type="button" th:attr="onclick=|updateQuantity([[${menuItem.menuItemId}]], 1, [[${userId}]],[[${merchantId}]])|">增加1份</button>
        <button type="button" th:attr="onclick=|updateQuantity([[${menuItem.menuItemId}]],-1, [[${userId}]],[[${merchantId}]])|">减少1份</button>
      </td>
    </tr>
    </tbody>
  </table>
  <button type="button" th:attr="onclick=|updateOrder([[${menuItems}]],[[${merchantId}]])|">确认提交点餐修改</button>
</div>
<br><br><br><br><br>

<div class="container" th:if="${!hasPendingOrder}">
  <h3>当前您在该商家没有正在进行中的订单，请选择订单类型，点击按钮创建订单。</h3>
  <label for="orderType">订单类型：</label>
  <select id="orderType">
    <option value="Queue">线下取餐</option>
    <option value="Online">线上点餐</option>
  </select>
  <button id="createOrderButton" th:attr="onclick=|createOrder([[${userId}]],[[${merchantId}]],'Pending')|">创建订单</button>
</div>
<div class="container" th:if="${hasPendingOrder}">
  <h3>当前您在该商家已有订单，请前往订单界面查看。</h3>
  <button id="viewOrders" th:attr="onclick=|viewOrders()|">查看订单</button>
</div>
<script th:inline="javascript">
  let order = {}; // 记录已选数量


  function updateQuantity(menuItemId, change,userId,merchantId) {
    var quantityElement = document.getElementById(`quantity`);
    let currentQuantity = parseInt(quantityElement.innerText);

    // 更新数量
    currentQuantity += change;
    if (currentQuantity < 0) {
      currentQuantity = 0;
    }

    // 更新DOM中的数量显示
    quantityElement.innerText = currentQuantity;

    // 更新购物车
    if (currentQuantity > 0) {
      order[menuItemId] = currentQuantity;
    } else {
      delete order[menuItemId];
    }
    //
    // updateOrder(menuItemId, currentQuantity,userId,merchantId);
  }

  let createOrderUrl;
  function redirectToCreateOrder(userId, merchantId, status,orderType) {
    var currentUrl = window.location.href;
    createOrderUrl = currentUrl.substring(0, currentUrl.indexOf('/menuItems')) + `/createOrder?userId=${userId}&merchantId=${merchantId}&status=${status}&orderType=${orderType}`;
    console.log(createOrderUrl);
    window.location.href = createOrderUrl;
  }
  function viewOrders() {
    var currentUrl = window.location.href;
    createOrderUrl = currentUrl.substring(0, currentUrl.indexOf('/menuItems')) + `/viewOrders`;
    console.log(createOrderUrl);
    window.location.href = createOrderUrl;
  }

  function createOrder(userId, merchantId, status) {
    const orderType = document.getElementById('orderType').value;
    redirectToCreateOrder(userId, merchantId, status,orderType);
  }


  function updateOrder(menuItems,merchantId) {
    // menuItemId, quantity,userId,merchantId
    var currentUrl = window.location.href;
    createOrderUrl = currentUrl.substring(0, currentUrl.indexOf('/menuItems')) + `/updateOrder3?&merchantId=${merchantId}&menuItems=${JSON.stringify(menuItems)}`;
    console.log(createOrderUrl);
    // // redirect
    // window.location.href = createOrderUrl;
    fetch(createOrderUrl, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        menuItems: menuItems,
        // userId: userId,
        merchantId: merchantId
      })
    })
            .then(response => response.json())
            .then(data => {
              console.log('Success:', data);
            })
            .catch((error) => {
              console.error('Error:', error);
            });
  }
</script>
</body>
</html>
