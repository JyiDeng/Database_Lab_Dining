# 数据库表结构说明
邓景宜 22302010075
吴苏庭 22302010087

## ER图设计说明

### ER图
![ER图](../pic/ER图.jpg)

### 实体关系
1. **用户 (User)/商户 (Merchant)** 和 **订单 (Order)**: 一对多关系，一个用户/商户可以发起/处理多个订单。
2. **订单 (Order)** 和 **订单每项 (OrderItem)**: 一对多关系，一个订单可以包含多个订单项。
3. **菜品 (Dish)** 和 **订单每项 (OrderItem)**: 一对一关系，一个订单项只可以包含一个菜品。
4. **商户 (Merchant)** 和 **菜品 (Dish)**: 一对多关系，一个商户可以有多个菜品。
5. **用户 (User)/菜品 (Dish)** 和 **评价 (Review)**: 多对多关系，一个用户可以对多个菜品进行评价，一个菜品可以有多个评价。
6. **用户 (User)/菜品 (Dish)** 和 **评分 (Rating)**: 多对多关系，一个用户可以对多个菜品进行评分，一个菜品可以有多个评分。
7. **用户 (User)/商户 (Merchant)** 和 **收藏 (Favorite)**: 多对多关系，一个用户可以收藏多个商户，一个商户可以被多个用户收藏。
8. **用户 (User)/菜品 (Dish)** 和 **收藏 (Favorite)**: 多对多关系，一个用户可以收藏多个菜品，一个菜品可以被多个用户收藏。
9. **用户 (User)** 和 **消息 (Message)**: 一对多关系，一个用户可以接收到多个消息，一条消息只能发给一个用户。
10. **管理员 (Admin)** 和 **操作日志 (AdminActionLog)**: 一对多关系，一个管理员可以进行多项操作，一项操作只能由一个管理员执行。

## 数据表概览

| 表名 | 属性 | 功能 |
|----|----|----|
| User | UserID (INT, PK), UserName (VARCHAR), Gender (ENUM), EcardID (INT), Role (ENUM), Age (INT), Password (VARCHAR) | 用户 |
| Merchant | MerchantID (INT, PK), MerchantName (VARCHAR), MainDishes (VARCHAR), Address (VARCHAR), Password (VARCHAR)| 商家 |
| Dish | DishID (INT, PK), DishName (VARCHAR), Category (VARCHAR), Description (VARCHAR), Picture (VARCHAR), Flavor (VARCHAR), Ingredients (VARCHAR), Allergens (VARCHAR), NutritionInfo (VARCHAR), MerchantID (INT, FK) | 菜品的详细信息 |
| MenuItem | MenuItemID (INT, PK), DishID (INT, FK), Price (DECIMAL)| 菜单项 |
| MenuPrice| MenuPriceID (INT, PK), MenuItemID (INT, FK), Price (DECIMAL), EffectiveDate (DATETIME) | 菜单项的价格及其有效日期 |
| FavoriteMerchant | FavoriteMerchantID (INT, PK), UserID (INT, FK), MerchantID (INT, FK), FavoriteDate (DATETIME) | 用户收藏商家的收藏记录 |
| FavoriteDish| FavoriteDishID (INT, PK), UserID (INT, FK), DishID (INT, FK), FavoriteDate (DATETIME) | 用户收藏菜品的收藏记录 |
| Review | ReviewID (INT, PK), UserID (INT, FK), MerchantID (INT, FK), DishID (INT, FK), Rating (DECIMAL), Content (TEXT), ReviewDate (DATETIME) | 用户对菜品或商家的评价信息 |
| MyOrder| OrderID (INT, PK), UserID (INT, FK), MerchantID (INT, FK), OrderDate (DATETIME), Status (ENUM), OrderType (ENUM), TotalPrice (DECIMAL) | 用户的订单 |
| OrderItem| OrderItemID (INT, PK), OrderID (INT, FK), DishID (INT, FK), Quantity (INT), Price (DECIMAL) | 订单项（菜品副本及其对应数量） |
| Admin| AdminID (INT, PK), Name (VARCHAR), Password (VARCHAR) | 管理员 |
| Message| MessageID (INT, PK), UserID (INT, FK), AdminID (INT, FK), Content (TEXT), MessageDate (DATETIME)| 管理员发送给用户的消息 |
| AdminActionLog | LogID (INT, PK), AdminID (INT, FK), ActionType (ENUM), TargetID (INT), Timestamp (DATETIME) | 记录管理员的操作日志 |

## 触发器说明
### 插入忠实用户信息
在每次向 MyOrder 表插入新记录后执行，计算用户在同一家商户的总消费次数。如果消费次数超过阈值（此处为大于等于5次）且 LoyalCustomers 表中**没有**该用户记录，则插入一条新记录。
```sql
DELIMITER //

CREATE TRIGGER InsertLoyalCustomer
AFTER INSERT ON MyOrder
FOR EACH ROW
BEGIN
    DECLARE purchase_count INT;

    -- 计算用户在商户的总消费次数
    SELECT COUNT(*) INTO purchase_count
    FROM MyOrder
    WHERE UserID = NEW.UserID AND MerchantID = NEW.MerchantID;

    -- 如果消费次数超过阈值且LoyalCustomers表中没有该记录，则插入
    IF purchase_count >= 5 THEN
        IF NOT EXISTS (
            SELECT 1 FROM LoyalCustomers
            WHERE UserID = NEW.UserID AND MerchantID = NEW.MerchantID
        ) THEN
            INSERT INTO LoyalCustomers (UserID, MerchantID, PurchaseCount)
            VALUES (NEW.UserID, NEW.MerchantID, purchase_count);
        END IF;
    END IF;
END //

DELIMITER ;
```

### 更新忠实用户信息
在每次向 MyOrder 表插入新记录后执行，计算用户在商户的总消费次数。如果消费次数超过阈值且 LoyalCustomers 表中**已有**该用户记录，则更新 PurchaseCount 字段。
```sql
DELIMITER //

CREATE TRIGGER UpdateLoyalCustomer
AFTER INSERT ON MyOrder
FOR EACH ROW
BEGIN
    DECLARE purchase_count INT;

    -- 计算用户在商户的总消费次数
    SELECT COUNT(*) INTO purchase_count
    FROM MyOrder
    WHERE UserID = NEW.UserID AND MerchantID = NEW.MerchantID;

    -- 如果消费次数超过阈值且LoyalCustomers表中有该记录，则更新
    IF purchase_count >= 5 THEN
        UPDATE LoyalCustomers
        SET PurchaseCount = purchase_count
        WHERE UserID = NEW.UserID AND MerchantID = NEW.MerchantID;
    END IF;
END //

DELIMITER ;
```