# PJ说明文档
邓景宜 22302010075
吴苏庭 22302010087

*由于"Data too long for column"，使用全英文数据*

## 0. 原理简述

### 0.1 `MyBatis和SpringBoot食用指南.md`

用易懂的方式介绍了Spring框架如何理解，以及Controller、html、Mapper相关部分的语法。

### 0.2 数据库接口正式的原理解释

+ 配置：在pom.xml中添加MyBatis和Spring Boot Starter的依赖；在db.properties等配置文件中配置数据库连接信息，包含账号密码等；建表的语句保存在根路径的文件里，在本地运行建表。
+ Mapper是映射文件，定义SQL映射，所有的SQL语句都在这里完成框架，调用方法的时候再把具体参数传入，形如userId = #{imported_userId}。
+ 在Controller层调用Mapper中的方法；在Controller层调用Service中的登录方法、事务功能。
+ Entity类的本质是Data Access Object（DAO）层，用于存放查询出来的数据。如果它的属性A和数据库建表时的有重合，就必须在命名上达成一致；如果它的属性B是由查询（譬如连接）得出的，那么要和查询出来重命名的内容一致。
+ 前端网页存储在templates文件夹中，由thymeleaf模版调用数据库通过mapper查询返回的数据，完成表格展示部分。


## 1. 运行方法
运行Pj1Application.java，然后打开浏览器，在网址栏输入`http://localhost:8014/` ，进入登录界面。登录后，分别来到用户、商家、管理员界面。

### 1.1. 用户发出查询
+ 假设此时进入第一个商家界面（通过登录界面）。
+ 在界面上有按钮能点击的基础查询：（以下网页可以通过修改参数访问不同id用户、菜品等，也可以在前端做交互选择菜品等，此处参数作为示例）
  + 用户索引页：`http://localhost:8014/user/`
  + 用户查询所有用户列表：`http://localhost:8014/user/allUserList`
  + 查询第1个用户信息：`http://localhost:8014/user/id=1`
  + 查询所有商家列表（简略）：`http://localhost:8014/user/searchMerchant?keyword=`
  + 查询第2个商家列表（简略）：`http://localhost:8014/user/searchMerchant?keyword=2`
  + 查询第3个商家列表（详细）：`http://localhost:8014/user/searchMerchantDetails?id=3`
    + 通过该界面内部，可以进行进一步搜索、查看菜单、加菜、点击提交订单等。
    + 体现为merchantDetail、menuIntro、menuItems、orderEndSuccess等界面
  + 查询第3个商家的关于`p`的菜品：`http://localhost:8014/user/searchDishes?merchantId=3&keyword=p`
  + 查询该用户用户信息：http://localhost:8014/user/1/userSelfInfo
  + 查询所有商家列表（简略）：http://localhost:8014/user/1/searchMerchant2?keyword=
  + 查询名字里含有“e”的商家列表（简略）：http://localhost:8014/user/1/searchMerchant2?keyword=e
  + 查询第3个（id=3）商家列表（详细）：http://localhost:8014/user/1/searchMerchantDetails?id=3
  + 查询第3个商家的关于`p`的菜品：http://localhost:8014/user/1/searchDishes?merchantId=3&keyword=p
  + 查询id=2的菜品的价格变化：http://localhost:8014/user/1/latestPrice/2
  + 收藏id为2的菜品：http://localhost:8014/user/1/addFavoriteDish?dishId=2
  + 查看当前收藏的所有菜品：http://localhost:8014/user/1/findFavoriteDish
  + 收藏id为3的商户：http://localhost:8014/user/1/addFavoriteMerchant?merchantId=3
  + 查看当前收藏的所有商户：http://localhost:8014/user/1/findFavoriteMerchant
  + 查看当前id为4的商户的所有菜品收藏量：http://localhost:8014/user/1/dishFavoriteCounts?merchantId=4
  + 预定id为2的餐厅：http://localhost:8014/user/1/reserve?id=2
  + 查询当前所有餐厅预定：http://localhost:8014/user/1/reserveDetail
  + 查询当前所有订单：http://localhost:8014/user/1/viewOrders
  + 查询当前id为1的菜品所有的评价：http://localhost:8014/user/1/review/1
  + 查询当前消息列表：http://localhost:8014/user/1/msg
+ 进阶查询入口：
  + 查看id=3的商户所有菜品销量统计（包含购买最多的用户）：http://localhost:8014/userAdvanced/1/sales?merchantId=3
  + 用户群体特征分析（评价习惯：评价的数量/评分给出的分数）：http://localhost:8014/userAdvanced/1/user-characteristics/reviews
  + 用户群体特征分析（身份区分：用户年龄）（评价习惯、菜品购买数量）：http://localhost:8014/userAdvanced/1/user-characteristics/age
  + 用户群体特征分析（身份区分：根据用户性别）：http://localhost:8014/userAdvanced/1/user-characteristics/gender
  + 用户群体特征分析（身份区分：根据用户角色）：http://localhost:8014/user/1/userAdvanced-characteristics/role
  + 查询用户id=3在3个月内的购买记录：http://localhost:8014/userAdvanced/1/favoriteSales?userId=3&timePeriod=3
  + 查询当前用户在一周内不同点餐方式的销量：http://localhost:8014/userAdvanced/1/user-activity/weekly
  + 查询当前用户在一月内不同点餐方式的销量：http://localhost:8014/userAdvanced/1/user-activity/monthly
  + 查询当前用户在一年内不同点餐方式的销量：http://localhost:8014/userAdvanced/1/user-activity/yearly
  + 查询id=4的商户的忠实粉丝在一月内的消费分布：http://localhost:8014/userAdvanced/1/loyalCustomer/monthly?merchantId=4
  + 查询当前用户活跃度（点餐频率变化趋势、时间段）：http://localhost:8014/userAdvanced/1/userFreq
  + 查询当前用户活跃度（点餐频率变化趋势、时间段）：http://localhost:8014/userAdvanced/1/userFreq
  + 新增：查看id=5的商户在一个月内的用户评分趋势变化：http://localhost:8014/userAdvanced/1/ratingTrend/monthly?merchantId=5

### 1.2. 商家发出查询示例
+ 商家索引页：`http://localhost:8014/merchant/`
+ 假设此时进入第一个商家界面（通过登录界面）
  + 查询该商家信息：`http://localhost:8014/merchant/1/merchantSelfInfo`
  + 增加新菜品（草莓，id=30，隶属于餐厅2，分类为蔬菜...）：`http://localhost:8014/merchant/1/addDish?dishId=30&dishName=strawberry&category=vegetable&description=fresh&picture=strawberry&flavor=sweet&ingredients=strawberry&allergens=strawberry&nutritionInfo=strawberry&merchantId=2`
  + 查看该商家所有菜品：：`http://localhost:8014/merchant/1/allDishes`
  + 更新菜品30分类为水果：`http://localhost:8014/merchant/1/updateDishCategory/30?category=fruit`
  + 删除菜品30：`http://localhost:8014/merchant/1/deleteDish?dishId=30`
  + 从菜单中删除菜品5：`http://localhost:8014/merchant/1/deleteMenuItem/5`
  + 修改菜品5的价格为18：`http://localhost:8014/merchant/1/updateMenuItemPrice/5?newPrice=18`

### 1.3. 管理员发出操作示例
+ 管理员索引页：`http://localhost:8014/admin/1/`
+ 增加id为4的用户，名字为jill，性别为Female，学工号为12321，角色为Student，年龄为20（如果已有这个id的用户会给出提示信息）：`http://localhost:8014/admin/1/addUser?id=4&userName=Jill&gender=Female&ecardId=12321&role=Student&age=20`
+ 更新id为1的用户的名字为JohnDoe，性别为Male，学工号为12345，角色为Staff，年龄为30（如果不存在这个id的用户会给出提示信息）：`http://localhost:8014/admin/1/updateUser?id=1&userName=JohnDoe&gender=Male&ecardId=12345&role=Staff&age=30`
+ 删除id为4的用户（如果不存在这个id的用户会给出提示信息）：`http://localhost:8014/admin/1/deleteUser/4`
+ 增加id为4的商户（如果已有这个id的用户会给出提示信息）：`http://localhost:8014/admin/1/addMerchant?id=4&name=Ramenya&mainDishes=Ramen&addr=bentoRoadNo1`
+ 更新id为4的商户（如果不存在这个id的用户会给出提示信息）：`http://localhost:8014/admin/1/updateMerchant?id=4&name=Kidtucky&mainDishes=ChickenNuggets&addr=FriedRoadNo2`
+ 删除id为4的商户（如果不存在这个id的用户会给出提示信息）：`http://localhost:8014/admin/1/deleteMerchant/4`



## 2. ER图与触发器设计说明
ER图与触发器说明请参见*数据库表结构说明.md*。

## 3. SQL语句设计说明
SQL语句说明请参见*核心功能SQL说明.md*。

## 4. 期间解决的各类问题

### 4.1. Mapper相关
1. 成功添加了数据，但是查询的时候显示某个属性为null：可能是实体类和数据库表中这个属性名称不一致（实体类中需要驼峰，数据库表中首字母小写，其他字母完全一致）
2. 在运行的类（如MyBatis001.java中）的`List<User> user = sqlSession.selectList("test.findAll");`找不到mybatis.findAll：`<mapper namespace="test">`所以需要改成test.findAll
3. `There was an unexpected error (500) Invalid bound statement: not found`：在controller类使用mapper而不是service来访问函数，并且在mapper里面直接使用@Select而不是写XML
4. `Mapped Statements collection already contains value for`：在mapper里面直接使用@Select而不是写XML

### 4.2. 数据库连接相关
1. 报错：`Failed to determine a suitable driver class`：错误地注释掉了pom.xml里看似重复的projectlombok、mybatis和mysql，补充回来即可。
2. 报错：`HTTP 405 Method Not Allowed`：多半是RequestMapping、GetMapping、PostMapping写串了

### 4.3. SQL相关
1. `Column ‘XXX‘ cannot be null`：可能不是空了，而是名字拼写问题，譬如数据库里EcardID，entity里ecardID，那么在查询语句里要写`EcardID = #{ecardID}`

### 4.4 前端相关
1. `Uncaught (in promise) TypeError: Cannot read properties of null (reading 'value')`：检查javascript里的变量名称和html里组件的是不是有错误的
2. thymeleaf中和Controller传过来的model的attribute也必须一样

